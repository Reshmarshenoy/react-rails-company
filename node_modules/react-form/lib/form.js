'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FormDefaultProps = undefined;

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

exports.default = Form;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }

var noop = function noop() {};
var reop = function reop(d) {
  return d;
};

var FormDefaultProps = exports.FormDefaultProps = {
  loadState: noop,
  defaultValues: {},
  preValidate: reop,
  validate: function validate() {
    return null;
  },
  onValidationFail: noop,
  onChange: noop,
  saveState: noop,
  willUnmount: noop,
  preSubmit: reop,
  onSubmit: noop,
  postSubmit: noop
};

function Form() {
  var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

  return function (Comp) {
    return _react2.default.createClass({
      childContextTypes: {
        formAPI: _react2.default.PropTypes.object
      },
      getChildContext: function getChildContext() {
        return {
          formAPI: this.getAPI()
        };
      },

      // Lifecycle
      getDefaultProps: function getDefaultProps() {
        return _extends({}, FormDefaultProps, config);
      },
      getInitialState: function getInitialState() {
        var values = _extends({}, _utils2.default.clone(config.defaultValues), _utils2.default.clone(this.props.values));
        return this.props.loadState(this.props) || {
          values: values,
          touched: {},
          errors: this.validate(values),
          nestedErrors: {}
        };
      },
      componentWillMount: function componentWillMount() {
        this.emitChange(this.state, true);
      },
      componentWillReceiveProps: function componentWillReceiveProps(props) {
        if (props.values === this.props.values) {
          return;
        }

        this.setFormState({
          values: _utils2.default.clone(props.values) || {}
        }, true);
      },
      componentWillUnmount: function componentWillUnmount() {
        this.props.willUnmount(this.state, this.props);
      },


      // API
      setValue: function setValue(field, value, noTouch) {
        var state = this.state;
        var values = _utils2.default.set(state.values, field, value);
        // Also set touched since the value is changing
        if (noTouch) {
          return this.setFormState({ values: values });
        }
        var touched = _utils2.default.set(state.touched, field, value);
        this.setFormState({ values: values, touched: touched });
      },
      getValue: function getValue(field, fallback) {
        var state = this.state;
        var val = _utils2.default.get(state.values, field);
        return typeof val !== 'undefined' ? val : fallback;
      },
      setNestedError: function setNestedError(field) {
        var value = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;

        var nestedErrors = _utils2.default.set(this.state.nestedErrors, field, value);
        this.setFormState({ nestedErrors: nestedErrors });
      },
      getError: function getError(field) {
        return _utils2.default.get(this.state.errors, field);
      },
      setTouched: function setTouched(field) {
        var value = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;

        var touched = _utils2.default.set(this.state.touched, field, value);
        this.setFormState({ touched: touched });
      },
      getTouched: function getTouched(field) {
        var state = this.state;
        if (this.state.dirty === true || this.props.touched === true) {
          return true;
        }
        return _utils2.default.get(state.touched, field);
      },
      addValue: function addValue(field, value) {
        var state = this.state;
        var values = _utils2.default.set(state.values, field, [].concat(_toConsumableArray(_utils2.default.get(state.values, field, [])), [value]));
        this.setFormState({ values: values });
      },
      removeValue: function removeValue(field, index) {
        var state = this.state;
        var fieldValue = _utils2.default.get(state.values, field, []);
        var values = _utils2.default.set(state.values, field, [].concat(_toConsumableArray(fieldValue.slice(0, index)), _toConsumableArray(fieldValue.slice(index + 1))));
        this.setFormState({ values: values });
      },
      swapValues: function swapValues(field, index, destIndex) {
        var state = this.state;
        var fieldValues = _utils2.default.get(state.values, field, []);
        var values = _utils2.default.set(state.values, field, [].concat(_toConsumableArray(fieldValues.slice(0, index)), [fieldValues[destIndex]], _toConsumableArray(fieldValues.slice(index + 1, destIndex)), [fieldValues[index]], _toConsumableArray(fieldValues.slice(destIndex + 1))));
        this.setFormState({ values: values });
      },
      setAllTouched: function setAllTouched() {
        var dirty = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;

        this.setFormState({ dirty: !!dirty });
      },
      submitForm: function submitForm(e) {
        e && e.preventDefault && e.preventDefault(e);
        var state = this.state;
        var errors = this.validate(state.values, state, this.props);
        if (errors) {
          if (!state.dirty) {
            this.setAllTouched();
          }
          return this.props.onValidationFail(state, this.props);
        }
        var preSubmitValues = this.props.preSubmit(state.values, state, this.props);
        this.props.onSubmit(preSubmitValues, state, this.props);
        this.props.postSubmit(preSubmitValues, state, this.props);
      },


      // Utils
      getAPI: function getAPI() {
        return {
          setValue: this.setValue,
          getValue: this.getValue,
          setNestedError: this.setNestedError,
          getError: this.getError,
          setTouched: this.setTouched,
          getTouched: this.getTouched,
          addValue: this.addValue,
          removeValue: this.removeValue,
          swapValues: this.swapValues,
          setAllTouched: this.setAllTouched,
          submitForm: this.submitForm
        };
      },
      setFormState: function setFormState(newState, silent) {
        var _this = this;

        if (newState && newState.values) {
          newState.values = this.props.preValidate(newState.values, newState, this.props);
          newState.errors = this.validate(newState.values, newState, this.props);
        }
        this.setState(newState, function () {
          _this.props.saveState(_this.state, _this.props);
          if (!silent) {
            _this.emitChange(_this.state, _this.props);
          }
        });
      },
      emitChange: function emitChange(state, initial) {
        this.props.onChange(state, this.props, initial);
      },
      validate: function validate(values) {
        var errors = this.props.validate(removeNestedErrorValues(values, this.state ? this.state.nestedErrors : {}));
        return cleanErrors(errors);
      },

      // Render
      render: function render() {
        var props = _extends({}, this.props, this.state, this.getAPI());
        return _react2.default.createElement(Comp, props);
      }
    });
  };
}

// Utils

function cleanErrors(err) {
  if (_utils2.default.isObject(err)) {
    var resolved = _utils2.default.mapValues(err, cleanErrors);
    var found = _utils2.default.pickBy(resolved, function (d) {
      return d;
    });
    return Object.keys(found).length ? resolved : undefined;
  }
  if (_utils2.default.isArray(err)) {
    var _resolved = err.map(cleanErrors);
    var _found = _resolved.find(function (d) {
      return d;
    });
    return _found ? _resolved : undefined;
  }
  return err;
}

function removeNestedErrorValues(value, nestedErrors) {
  var recurse = function recurse(value) {
    var path = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

    if (_utils2.default.get(nestedErrors, path)) {
      return undefined;
    }
    if (_utils2.default.isObject(value)) {
      return _utils2.default.mapValues(value, function (d, i) {
        return recurse(d, [].concat(_toConsumableArray(path), [i]));
      });
    }
    if (_utils2.default.isArray(value)) {
      return value.map(function (d, key) {
        return recurse(d, [].concat(_toConsumableArray(path), [key]));
      });
    }
    return value;
  };
  return recurse(value);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9mb3JtLmpzIl0sIm5hbWVzIjpbIkZvcm0iLCJub29wIiwicmVvcCIsImQiLCJGb3JtRGVmYXVsdFByb3BzIiwibG9hZFN0YXRlIiwiZGVmYXVsdFZhbHVlcyIsInByZVZhbGlkYXRlIiwidmFsaWRhdGUiLCJvblZhbGlkYXRpb25GYWlsIiwib25DaGFuZ2UiLCJzYXZlU3RhdGUiLCJ3aWxsVW5tb3VudCIsInByZVN1Ym1pdCIsIm9uU3VibWl0IiwicG9zdFN1Ym1pdCIsImNvbmZpZyIsIkNvbXAiLCJjcmVhdGVDbGFzcyIsImNoaWxkQ29udGV4dFR5cGVzIiwiZm9ybUFQSSIsIlByb3BUeXBlcyIsIm9iamVjdCIsImdldENoaWxkQ29udGV4dCIsImdldEFQSSIsImdldERlZmF1bHRQcm9wcyIsImdldEluaXRpYWxTdGF0ZSIsInZhbHVlcyIsImNsb25lIiwicHJvcHMiLCJ0b3VjaGVkIiwiZXJyb3JzIiwibmVzdGVkRXJyb3JzIiwiY29tcG9uZW50V2lsbE1vdW50IiwiZW1pdENoYW5nZSIsInN0YXRlIiwiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyIsInNldEZvcm1TdGF0ZSIsImNvbXBvbmVudFdpbGxVbm1vdW50Iiwic2V0VmFsdWUiLCJmaWVsZCIsInZhbHVlIiwibm9Ub3VjaCIsInNldCIsImdldFZhbHVlIiwiZmFsbGJhY2siLCJ2YWwiLCJnZXQiLCJzZXROZXN0ZWRFcnJvciIsImdldEVycm9yIiwic2V0VG91Y2hlZCIsImdldFRvdWNoZWQiLCJkaXJ0eSIsImFkZFZhbHVlIiwicmVtb3ZlVmFsdWUiLCJpbmRleCIsImZpZWxkVmFsdWUiLCJzbGljZSIsInN3YXBWYWx1ZXMiLCJkZXN0SW5kZXgiLCJmaWVsZFZhbHVlcyIsInNldEFsbFRvdWNoZWQiLCJzdWJtaXRGb3JtIiwiZSIsInByZXZlbnREZWZhdWx0IiwicHJlU3VibWl0VmFsdWVzIiwibmV3U3RhdGUiLCJzaWxlbnQiLCJzZXRTdGF0ZSIsImluaXRpYWwiLCJyZW1vdmVOZXN0ZWRFcnJvclZhbHVlcyIsImNsZWFuRXJyb3JzIiwicmVuZGVyIiwiZXJyIiwiaXNPYmplY3QiLCJyZXNvbHZlZCIsIm1hcFZhbHVlcyIsImZvdW5kIiwicGlja0J5IiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsInVuZGVmaW5lZCIsImlzQXJyYXkiLCJtYXAiLCJmaW5kIiwicmVjdXJzZSIsInBhdGgiLCJpIiwia2V5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7a0JBb0J3QkEsSTs7QUFwQnhCOzs7O0FBQ0E7Ozs7Ozs7O0FBRUEsSUFBTUMsT0FBTyxTQUFQQSxJQUFPLEdBQU0sQ0FBRSxDQUFyQjtBQUNBLElBQU1DLE9BQU8sU0FBUEEsSUFBTztBQUFBLFNBQUtDLENBQUw7QUFBQSxDQUFiOztBQUVPLElBQU1DLDhDQUFtQjtBQUM5QkMsYUFBV0osSUFEbUI7QUFFOUJLLGlCQUFlLEVBRmU7QUFHOUJDLGVBQWFMLElBSGlCO0FBSTlCTSxZQUFVO0FBQUEsV0FBTSxJQUFOO0FBQUEsR0FKb0I7QUFLOUJDLG9CQUFrQlIsSUFMWTtBQU05QlMsWUFBVVQsSUFOb0I7QUFPOUJVLGFBQVdWLElBUG1CO0FBUTlCVyxlQUFhWCxJQVJpQjtBQVM5QlksYUFBV1gsSUFUbUI7QUFVOUJZLFlBQVViLElBVm9CO0FBVzlCYyxjQUFZZDtBQVhrQixDQUF6Qjs7QUFjUSxTQUFTRCxJQUFULEdBQTRCO0FBQUEsTUFBYmdCLE1BQWEsdUVBQUosRUFBSTs7QUFDekMsU0FBTyxVQUFDQyxJQUFELEVBQVU7QUFDZixXQUFPLGdCQUFNQyxXQUFOLENBQWtCO0FBQ3ZCQyx5QkFBbUI7QUFDakJDLGlCQUFTLGdCQUFNQyxTQUFOLENBQWdCQztBQURSLE9BREk7QUFJdkJDLHFCQUp1Qiw2QkFJSjtBQUNqQixlQUFPO0FBQ0xILG1CQUFTLEtBQUtJLE1BQUw7QUFESixTQUFQO0FBR0QsT0FSc0I7O0FBU3ZCO0FBQ0FDLHFCQVZ1Qiw2QkFVSjtBQUNqQixlQUFPLFNBQWMsRUFBZCxFQUFrQnJCLGdCQUFsQixFQUFvQ1ksTUFB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LENBQVUsVUFBQ2pGLENBQUQsRUFBSXNGLEdBQUosRUFBWTtBQUMzQixlQUFPSCxRQUFRbkYsQ0FBUiwrQkFBZW9GLElBQWYsSUFBcUJFLEdBQXJCLEdBQVA7QUFDRCxPQUZNLENBQVA7QUFHRDtBQUNELFdBQU9oRCxLQUFQO0FBQ0QsR0FmRDtBQWdCQSxTQUFPNkMsUUFBUTdDLEtBQVIsQ0FBUDtBQUNEIiwiZmlsZSI6ImZvcm0uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXG5pbXBvcnQgXyBmcm9tICcuL3V0aWxzJ1xuXG5jb25zdCBub29wID0gKCkgPT4ge31cbmNvbnN0IHJlb3AgPSBkID0+IGRcblxuZXhwb3J0IGNvbnN0IEZvcm1EZWZhdWx0UHJvcHMgPSB7XG4gIGxvYWRTdGF0ZTogbm9vcCxcbiAgZGVmYXVsdFZhbHVlczoge30sXG4gIHByZVZhbGlkYXRlOiByZW9wLFxuICB2YWxpZGF0ZTogKCkgPT4gbnVsbCxcbiAgb25WYWxpZGF0aW9uRmFpbDogbm9vcCxcbiAgb25DaGFuZ2U6IG5vb3AsXG4gIHNhdmVTdGF0ZTogbm9vcCxcbiAgd2lsbFVubW91bnQ6IG5vb3AsXG4gIHByZVN1Ym1pdDogcmVvcCxcbiAgb25TdWJtaXQ6IG5vb3AsXG4gIHBvc3RTdWJtaXQ6IG5vb3Bcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gRm9ybSAoY29uZmlnID0ge30pIHtcbiAgcmV0dXJuIChDb21wKSA9PiB7XG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUNsYXNzKHtcbiAgICAgIGNoaWxkQ29udGV4dFR5cGVzOiB7XG4gICAgICAgIGZvcm1BUEk6IFJlYWN0LlByb3BUeXBlcy5vYmplY3RcbiAgICAgIH0sXG4gICAgICBnZXRDaGlsZENvbnRleHQgKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGZvcm1BUEk6IHRoaXMuZ2V0QVBJKClcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIC8vIExpZmVjeWNsZVxuICAgICAgZ2V0RGVmYXVsdFByb3BzICgpIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIEZvcm1EZWZhdWx0UHJvcHMsIGNvbmZpZylcbiAgICAgIH0sXG4gICAgICBnZXRJbml0aWFsU3RhdGUgKCkge1xuICAgICAgICBjb25zdCB2YWx1ZXMgPSBPYmplY3QuYXNzaWduKHt9LCBfLmNsb25lKGNvbmZpZy5kZWZhdWx0VmFsdWVzKSwgXy5jbG9uZSh0aGlzLnByb3BzLnZhbHVlcykpXG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLmxvYWRTdGF0ZSh0aGlzLnByb3BzKSB8fCB7XG4gICAgICAgICAgdmFsdWVzLFxuICAgICAgICAgIHRvdWNoZWQ6IHt9LFxuICAgICAgICAgIGVycm9yczogdGhpcy52YWxpZGF0ZSh2YWx1ZXMpLFxuICAgICAgICAgIG5lc3RlZEVycm9yczoge31cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGNvbXBvbmVudFdpbGxNb3VudCAoKSB7XG4gICAgICAgIHRoaXMuZW1pdENoYW5nZSh0aGlzLnN0YXRlLCB0cnVlKVxuICAgICAgfSxcbiAgICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgKHByb3BzKSB7XG4gICAgICAgIGlmIChwcm9wcy52YWx1ZXMgPT09IHRoaXMucHJvcHMudmFsdWVzKSB7XG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNldEZvcm1TdGF0ZSh7XG4gICAgICAgICAgdmFsdWVzOiBfLmNsb25lKHByb3BzLnZhbHVlcykgfHwge31cbiAgICAgICAgfSwgdHJ1ZSlcbiAgICAgIH0sXG4gICAgICBjb21wb25lbnRXaWxsVW5tb3VudCAoKSB7XG4gICAgICAgIHRoaXMucHJvcHMud2lsbFVubW91bnQodGhpcy5zdGF0ZSwgdGhpcy5wcm9wcylcbiAgICAgIH0sXG5cbiAgICAgIC8vIEFQSVxuICAgICAgc2V0VmFsdWUgKGZpZWxkLCB2YWx1ZSwgbm9Ub3VjaCkge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc3RhdGVcbiAgICAgICAgY29uc3QgdmFsdWVzID0gXy5zZXQoc3RhdGUudmFsdWVzLCBmaWVsZCwgdmFsdWUpXG4gICAgICAgIC8vIEFsc28gc2V0IHRvdWNoZWQgc2luY2UgdGhlIHZhbHVlIGlzIGNoYW5naW5nXG4gICAgICAgIGlmIChub1RvdWNoKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2V0Rm9ybVN0YXRlKHt2YWx1ZXN9KVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRvdWNoZWQgPSBfLnNldChzdGF0ZS50b3VjaGVkLCBmaWVsZCwgdmFsdWUpXG4gICAgICAgIHRoaXMuc2V0Rm9ybVN0YXRlKHt2YWx1ZXMsIHRvdWNoZWR9KVxuICAgICAgfSxcbiAgICAgIGdldFZhbHVlIChmaWVsZCwgZmFsbGJhY2spIHtcbiAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgICAgIGNvbnN0IHZhbCA9IF8uZ2V0KHN0YXRlLnZhbHVlcywgZmllbGQpXG4gICAgICAgIHJldHVybiB0eXBlb2YgdmFsICE9PSAndW5kZWZpbmVkJyA/IHZhbCA6IGZhbGxiYWNrXG4gICAgICB9LFxuICAgICAgc2V0TmVzdGVkRXJyb3IgKGZpZWxkLCB2YWx1ZSA9IHRydWUpIHtcbiAgICAgICAgY29uc3QgbmVzdGVkRXJyb3JzID0gXy5zZXQodGhpcy5zdGF0ZS5uZXN0ZWRFcnJvcnMsIGZpZWxkLCB2YWx1ZSlcbiAgICAgICAgdGhpcy5zZXRGb3JtU3RhdGUoe25lc3RlZEVycm9yc30pXG4gICAgICB9LFxuICAgICAgZ2V0RXJyb3IgKGZpZWxkKSB7XG4gICAgICAgIHJldHVybiBfLmdldCh0aGlzLnN0YXRlLmVycm9ycywgZmllbGQpXG4gICAgICB9LFxuICAgICAgc2V0VG91Y2hlZCAoZmllbGQsIHZhbHVlID0gdHJ1ZSkge1xuICAgICAgICBjb25zdCB0b3VjaGVkID0gXy5zZXQodGhpcy5zdGF0ZS50b3VjaGVkLCBmaWVsZCwgdmFsdWUpXG4gICAgICAgIHRoaXMuc2V0Rm9ybVN0YXRlKHt0b3VjaGVkfSlcbiAgICAgIH0sXG4gICAgICBnZXRUb3VjaGVkIChmaWVsZCkge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc3RhdGVcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuZGlydHkgPT09IHRydWUgfHwgdGhpcy5wcm9wcy50b3VjaGVkID09PSB0cnVlKSB7XG4gICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gXy5nZXQoc3RhdGUudG91Y2hlZCwgZmllbGQpXG4gICAgICB9LFxuICAgICAgYWRkVmFsdWUgKGZpZWxkLCB2YWx1ZSkge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc3RhdGVcbiAgICAgICAgY29uc3QgdmFsdWVzID0gXy5zZXQoc3RhdGUudmFsdWVzLCBmaWVsZCwgW1xuICAgICAgICAgIC4uLl8uZ2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtdKSxcbiAgICAgICAgICB2YWx1ZVxuICAgICAgICBdKVxuICAgICAgICB0aGlzLnNldEZvcm1TdGF0ZSh7dmFsdWVzfSlcbiAgICAgIH0sXG4gICAgICByZW1vdmVWYWx1ZSAoZmllbGQsIGluZGV4KSB7XG4gICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5zdGF0ZVxuICAgICAgICBjb25zdCBmaWVsZFZhbHVlID0gXy5nZXQoc3RhdGUudmFsdWVzLCBmaWVsZCwgW10pXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IF8uc2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtcbiAgICAgICAgICAuLi5maWVsZFZhbHVlLnNsaWNlKDAsIGluZGV4KSxcbiAgICAgICAgICAuLi5maWVsZFZhbHVlLnNsaWNlKGluZGV4ICsgMSlcbiAgICAgICAgXSlcbiAgICAgICAgdGhpcy5zZXRGb3JtU3RhdGUoe3ZhbHVlc30pXG4gICAgICB9LFxuICAgICAgc3dhcFZhbHVlcyAoZmllbGQsIGluZGV4LCBkZXN0SW5kZXgpIHtcbiAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgICAgIGNvbnN0IGZpZWxkVmFsdWVzID0gXy5nZXQoc3RhdGUudmFsdWVzLCBmaWVsZCwgW10pXG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IF8uc2V0KHN0YXRlLnZhbHVlcywgZmllbGQsIFtcbiAgICAgICAgICAuLi5maWVsZFZhbHVlcy5zbGljZSgwLCBpbmRleCksXG4gICAgICAgICAgZmllbGRWYWx1ZXNbZGVzdEluZGV4XSxcbiAgICAgICAgICAuLi5maWVsZFZhbHVlcy5zbGljZShpbmRleCArIDEsIGRlc3RJbmRleCksXG4gICAgICAgICAgZmllbGRWYWx1ZXNbaW5kZXhdLFxuICAgICAgICAgIC4uLmZpZWxkVmFsdWVzLnNsaWNlKGRlc3RJbmRleCArIDEpXG4gICAgICAgIF0pXG4gICAgICAgIHRoaXMuc2V0Rm9ybVN0YXRlKHt2YWx1ZXN9KVxuICAgICAgfSxcbiAgICAgIHNldEFsbFRvdWNoZWQgKGRpcnR5ID0gdHJ1ZSkge1xuICAgICAgICB0aGlzLnNldEZvcm1TdGF0ZSh7ZGlydHk6ICEhZGlydHl9KVxuICAgICAgfSxcbiAgICAgIHN1Ym1pdEZvcm0gKGUpIHtcbiAgICAgICAgZSAmJiBlLnByZXZlbnREZWZhdWx0ICYmIGUucHJldmVudERlZmF1bHQoZSlcbiAgICAgICAgY29uc3Qgc3RhdGUgPSB0aGlzLnN0YXRlXG4gICAgICAgIGNvbnN0IGVycm9ycyA9IHRoaXMudmFsaWRhdGUoc3RhdGUudmFsdWVzLCBzdGF0ZSwgdGhpcy5wcm9wcylcbiAgICAgICAgaWYgKGVycm9ycykge1xuICAgICAgICAgIGlmICghc3RhdGUuZGlydHkpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0QWxsVG91Y2hlZCgpXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0aGlzLnByb3BzLm9uVmFsaWRhdGlvbkZhaWwoc3RhdGUsIHRoaXMucHJvcHMpXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcHJlU3VibWl0VmFsdWVzID0gdGhpcy5wcm9wcy5wcmVTdWJtaXQoc3RhdGUudmFsdWVzLCBzdGF0ZSwgdGhpcy5wcm9wcylcbiAgICAgICAgdGhpcy5wcm9wcy5vblN1Ym1pdChwcmVTdWJtaXRWYWx1ZXMsIHN0YXRlLCB0aGlzLnByb3BzKVxuICAgICAgICB0aGlzLnByb3BzLnBvc3RTdWJtaXQocHJlU3VibWl0VmFsdWVzLCBzdGF0ZSwgdGhpcy5wcm9wcylcbiAgICAgIH0sXG5cbiAgICAgIC8vIFV0aWxzXG4gICAgICBnZXRBUEkgKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHNldFZhbHVlOiB0aGlzLnNldFZhbHVlLFxuICAgICAgICAgIGdldFZhbHVlOiB0aGlzLmdldFZhbHVlLFxuICAgICAgICAgIHNldE5lc3RlZEVycm9yOiB0aGlzLnNldE5lc3RlZEVycm9yLFxuICAgICAgICAgIGdldEVycm9yOiB0aGlzLmdldEVycm9yLFxuICAgICAgICAgIHNldFRvdWNoZWQ6IHRoaXMuc2V0VG91Y2hlZCxcbiAgICAgICAgICBnZXRUb3VjaGVkOiB0aGlzLmdldFRvdWNoZWQsXG4gICAgICAgICAgYWRkVmFsdWU6IHRoaXMuYWRkVmFsdWUsXG4gICAgICAgICAgcmVtb3ZlVmFsdWU6IHRoaXMucmVtb3ZlVmFsdWUsXG4gICAgICAgICAgc3dhcFZhbHVlczogdGhpcy5zd2FwVmFsdWVzLFxuICAgICAgICAgIHNldEFsbFRvdWNoZWQ6IHRoaXMuc2V0QWxsVG91Y2hlZCxcbiAgICAgICAgICBzdWJtaXRGb3JtOiB0aGlzLnN1Ym1pdEZvcm1cbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHNldEZvcm1TdGF0ZSAobmV3U3RhdGUsIHNpbGVudCkge1xuICAgICAgICBpZiAobmV3U3RhdGUgJiYgbmV3U3RhdGUudmFsdWVzKSB7XG4gICAgICAgICAgbmV3U3RhdGUudmFsdWVzID0gdGhpcy5wcm9wcy5wcmVWYWxpZGF0ZShuZXdTdGF0ZS52YWx1ZXMsIG5ld1N0YXRlLCB0aGlzLnByb3BzKVxuICAgICAgICAgIG5ld1N0YXRlLmVycm9ycyA9IHRoaXMudmFsaWRhdGUobmV3U3RhdGUudmFsdWVzLCBuZXdTdGF0ZSwgdGhpcy5wcm9wcylcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKG5ld1N0YXRlLCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5wcm9wcy5zYXZlU3RhdGUodGhpcy5zdGF0ZSwgdGhpcy5wcm9wcylcbiAgICAgICAgICBpZiAoIXNpbGVudCkge1xuICAgICAgICAgICAgdGhpcy5lbWl0Q2hhbmdlKHRoaXMuc3RhdGUsIHRoaXMucHJvcHMpXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSxcbiAgICAgIGVtaXRDaGFuZ2UgKHN0YXRlLCBpbml0aWFsKSB7XG4gICAgICAgIHRoaXMucHJvcHMub25DaGFuZ2Uoc3RhdGUsIHRoaXMucHJvcHMsIGluaXRpYWwpXG4gICAgICB9LFxuICAgICAgdmFsaWRhdGUgKHZhbHVlcykge1xuICAgICAgICBjb25zdCBlcnJvcnMgPSB0aGlzLnByb3BzLnZhbGlkYXRlKFxuICAgICAgICAgIHJlbW92ZU5lc3RlZEVycm9yVmFsdWVzKHZhbHVlcywgdGhpcy5zdGF0ZSA/IHRoaXMuc3RhdGUubmVzdGVkRXJyb3JzIDoge30pXG4gICAgICAgIClcbiAgICAgICAgcmV0dXJuIGNsZWFuRXJyb3JzKGVycm9ycylcbiAgICAgIH0sXG4gICAgICAvLyBSZW5kZXJcbiAgICAgIHJlbmRlciAoKSB7XG4gICAgICAgIGNvbnN0IHByb3BzID0ge1xuICAgICAgICAgIC4uLnRoaXMucHJvcHMsXG4gICAgICAgICAgLi4udGhpcy5zdGF0ZSxcbiAgICAgICAgICAuLi50aGlzLmdldEFQSSgpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICA8Q29tcCB7Li4ucHJvcHN9IC8+XG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9KVxuICB9XG59XG5cbi8vIFV0aWxzXG5cbmZ1bmN0aW9uIGNsZWFuRXJyb3JzIChlcnIpIHtcbiAgaWYgKF8uaXNPYmplY3QoZXJyKSkge1xuICAgIGNvbnN0IHJlc29sdmVkID0gXy5tYXBWYWx1ZXMoZXJyLCBjbGVhbkVycm9ycylcbiAgICBjb25zdCBmb3VuZCA9IF8ucGlja0J5KHJlc29sdmVkLCBkID0+IGQpXG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKGZvdW5kKS5sZW5ndGggPyByZXNvbHZlZCA6IHVuZGVmaW5lZFxuICB9XG4gIGlmIChfLmlzQXJyYXkoZXJyKSkge1xuICAgIGNvbnN0IHJlc29sdmVkID0gZXJyLm1hcChjbGVhbkVycm9ycylcbiAgICBjb25zdCBmb3VuZCA9IHJlc29sdmVkLmZpbmQoZCA9PiBkKVxuICAgIHJldHVybiBmb3VuZCA/IHJlc29sdmVkIDogdW5kZWZpbmVkXG4gIH1cbiAgcmV0dXJuIGVyclxufVxuXG5mdW5jdGlvbiByZW1vdmVOZXN0ZWRFcnJvclZhbHVlcyAodmFsdWUsIG5lc3RlZEVycm9ycykge1xuICBjb25zdCByZWN1cnNlID0gKHZhbHVlLCBwYXRoID0gW10pID0+IHtcbiAgICBpZiAoXy5nZXQobmVzdGVkRXJyb3JzLCBwYXRoKSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgIH1cbiAgICBpZiAoXy5pc09iamVjdCh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiBfLm1hcFZhbHVlcyh2YWx1ZSwgKGQsIGkpID0+IHtcbiAgICAgICAgcmV0dXJuIHJlY3Vyc2UoZCwgWy4uLnBhdGgsIGldKVxuICAgICAgfSlcbiAgICB9XG4gICAgaWYgKF8uaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiB2YWx1ZS5tYXAoKGQsIGtleSkgPT4ge1xuICAgICAgICByZXR1cm4gcmVjdXJzZShkLCBbLi4ucGF0aCwga2V5XSlcbiAgICAgIH0pXG4gICAgfVxuICAgIHJldHVybiB2YWx1ZVxuICB9XG4gIHJldHVybiByZWN1cnNlKHZhbHVlKVxufVxuIl19